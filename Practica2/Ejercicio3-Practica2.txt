program Ej3P2;
Uses crt;
const
  valorAlto = '9999';
type

  producto = record
    codigo : String[4];
    nombre : String[20];
    descrip : String[20];
    stockDisp : integer;
    stockMin : integer;
    precio : real;
  end;

  detProducto = record
    codigo : String[4];
    cantVen : integer;
  end;

  maestro = file of producto;
  detalle = file of detProducto;

procedure leer(var detP : detProducto);
begin
  write('Ingrese codigo de producto ');
  readln(detP.codigo);
  if(detP.codigo <> '9999') then begin
    write('Ingrese cantidad vendida ');
    readln(detP.cantVen);
  end;
end;

procedure cargoDetalle(var det : detalle);
var
  detP : detProducto;
begin

  writeln('Cargo el archivo detalle');
  rewrite(det);

  leer(detP);
  while(detP.codigo <> '9999') do begin

    write(det, detP);

    leer(detP);
  end;

  close(det);

end;

procedure leer(var det : detalle; var detP : detProducto);
begin
  if(not(eof(det))) then
    read(det, detP)
  else
    detP.codigo := valorAlto;
end;


procedure actualizoMaestro(var mae : maestro; var det : detalle);
var
  detP : detProducto;
  regP : producto;
  aux : String[4];
  total, i : integer;
begin

  writeln('Actualizo el archivo maestro');
  reset(mae);
  reset(det);

  read(mae, regP);
  leer(det, detP);

  while(detP.codigo <> valorAlto) do begin
    aux := detP.codigo;
    total := 0;

    while(aux = detP.codigo) do begin
      total := total + detP.cantVen;
      leer(det, detP);
    end;

   while (regP.codigo <> aux) do
      read (mae, regP);

    regP.stockDisp := regP.stockDisp - total;

    seek(mae, filepos(mae) - 1);

    write(mae, regP);

    if(not(eof(mae))) then
      read(mae, regP);

  end;

  close(det);
  close(mae);

end;


procedure actualizoArchivos(var mae : maestro; var det : detalle);
var
  i : integer;
begin

  for i := 1 to 30 do begin
    cargoDetalle(det);
    writeln;
    actualizoMaestro(mae,det);
    writeln;
  end;

end;


procedure creoReporteProductos(var mae : maestro);
var
  regP : producto;
  reporteProductos : Text;
begin

  writeln('Creo reporte txt de productos por debajo dek stock minimo');
  assign(reporteProductos, 'reporteProductos.txt');
  reset(mae);
  rewrite(reporteProductos);
  while(not eof(mae)) do begin
    read(mae,regP);
    if(regP.stockDisp < regP.stockMin) then begin
      write(reporteProductos, regP.nombre,' ',regP.descrip,' ',regP.stockDisp,' ',regP.precio:2:2);
      write(reporteProductos,' ');
    end;
  end;
  close(mae);
  close(reporteProductos);

end;

var
  mae : maestro;
  det : detalle;
  regP : producto;
begin
  clrscr;

  assign(mae, 'Productos');
  assign(det, 'DetallePro');

  actualizoArchivos(mae,det);

  writeln;
  writeln('Archivo maestro actualizado');
  reset(mae);
  while(not eof(mae)) do begin
    read(mae, regP);
    writeln('Codigo ',regP.codigo,' nombre ',regP.nombre, ' stock disponible ',regP.stockDisp);
  end;
  close(mae);

  writeln;
  creoReporteProductos(mae);

  readln;
end.